#!/bin/bash

trcpub
trcconfig -env=$KUBEENV
#TODO: Duplicate certs output on next line because jks file doesn't work with decrypt key.
trcconfig -env=$KUBEENV -certs

ARN=$(kubectl config current-context)
kubectl config set-context kafka-$KUBEENV --cluster=$ARN --user=$ARN
kubectl config use-context dev

#Create config files and secrets
kubectl create secret generic hello-cert --namespace=$KUBENAMESPACE --from-file=hello.crt --dry-run=client -o yaml | kubectl apply -f -
kubectl create secret generic hello-key --namespace=$KUBENAMESPACE --from-file=hellokey.key --dry-run=client -o yaml | kubectl apply -f -
kubectl create configmap hello-application-config --namespace=$KUBENAMESPACE --from-file=config.yml --dry-run=client -o yaml | kubectl apply -f -

kubectl apply -f deploy/deployment.yaml --namespace=$KUBENAMESPACE

kubectl rollout restart deployment/hello -n $KUBENAMESPACE
